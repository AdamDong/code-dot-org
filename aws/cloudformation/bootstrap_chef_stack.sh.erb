#!/bin/bash -x
# UserData bootstrap script for CloudFormation stack instances.
# Note: Minimize changes to this script! Every time its contents change,
# the next CloudFormation update will reboot all servers using this script.

STACK=<%=stack_name%>
REGION=<%=region%>
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
RESOURCE_ID=<%=resource_id%>
COMMIT=<%=commit%>

# Update frontend hostname using local-mode chef-client.
pushd /var/chef/cache
  chef-client -z -N <%=node_name%> -o 'recipe[cdo-apps::hostname]'
popd

# Signal CloudFormation, in case this instance was launched from a CloudFormation stack update.
aws cloudformation signal-resource \
  --status SUCCESS \
  --unique-id ${INSTANCE_ID} \
  --stack-name ${STACK} \
  --logical-resource-id ${RESOURCE_ID} \
  --region ${REGION} \
  || true
