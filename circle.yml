general:
  artifacts:
    - dashboard/test/ui
    - dashboard/log
    - pegasus/log
machine:
  ruby:
    version: 2.2.3
  node:
    version: 0.12.0
  environment:
    RAILS_ENV: test
  services:
    - docker
dependencies:
  cache_directories:
    - "apps/node_modules"
    - "~/.rvm/gems/ruby-2.2.3"
  override:
    - sudo apt-get install libicu-dev
    - bundle install
    - 'echo "bundler_use_sudo: false" >> locals.yml'
    - 'echo "npm_use_sudo: false" >> locals.yml'
    - 'echo "assets_s3_directory: assets_circle/$RANDOM" >> locals.yml'
    - 'echo "sources_s3_directory: sources_circle/$RANDOM" >> locals.yml'
    - 'echo "properties_encryption_key: $PROPERTIES_ENCRYPTION_KEY" >> locals.yml'
    - 'echo "saucelabs_username: $SAUCE_USERNAME" >> locals.yml'
    - 'echo "saucelabs_authkey: $SAUCE_ACCESS_KEY" >> locals.yml'
    - 'echo "use_my_apps: true" >> locals.yml'
    - 'echo "use_my_shared_js: true" >> locals.yml'
    - 'echo "build_blockly_core: true" >> locals.yml'
    - 'echo "build_apps: true" >> locals.yml'
    - 'echo "build_code_studio: true" >> locals.yml'
    - 'echo "build_shared_js: true" >> locals.yml'
    - 'echo "build_dashboard: true" >> locals.yml'
    - 'echo "build_pegasus: true" >> locals.yml'
  post:
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz
database:
    override:
      - bundle exec rake db:create:
          pwd:
              dashboard
      - bundle exec rake db:schema:load:
          pwd:
              dashboard
    post:
      - bundle exec rake assets:precompile:
          pwd:
              dashboard
      # temporarily set hoc flags to green, as is currently required for dev enlistments
      - ./set_hoc_flags.rb green:
          pwd:
              bin/dynamic_config
test:
    override:
        # Run rake install
        - bundle exec rake install
        # Try running rake build twice (in case of intermittent test failures within rake build)
        - for i in 1 2; do bundle exec rake build && break; done
        - bundle exec rake test:changed
        - bundle exec rake konacha:run:
            pwd:
                dashboard
        - ./test.sh:
            pwd:
                cookbooks
        # The following should only be run when [run-ui-tests] included in commit hash
        - "./bin/circle/should-ui-test [run-ui-tests] && ./bin/dashboard-server":
            background: true
        - "./bin/circle/should-ui-test [run-ui-tests] && cd sc-*-linux && ./bin/sc -u $SAUCE_USERNAME -k $SAUCE_ACCESS_KEY":
            background: true
        - "./bin/circle/should-ui-test [run-ui-tests] && until $(curl --output /dev/null --silent --head --fail http://localhost.studio.code.org:3000); do sleep 5; done"
        - "./bin/circle/should-ui-test [run-ui-tests] && ./runner.rb -c ChromeLatestWin7 -p localhost.code.org:3000 -d localhost.studio.code.org:3000 --parallel 7 --auto_retry --html":
            pwd:
                dashboard/test/ui
