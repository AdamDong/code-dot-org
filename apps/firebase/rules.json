{
  "rules": {
    "v3": {
      "shared-tables": {
        ".read": "true",
        "$channel_id": {
          "server_time": {
            "$user_id": {
              ".validate": "newData.isNumber() && newData.val() == now",
              ".write": "auth.uid == $user_id"
            }
          },
          "counters": {
            "$table_name": {
              ".validate": "newData.isNumber() && newData.val() == (data.val() == null ? 0 : data.val()) + 1",
              ".write": "auth.uid != null && newData.val() != null"
            }
          },
          "tables": {
            "$table_name": {
              "target_record_id": {
                ".validate": "newData.isString()",
                ".write": "auth.uid != null && newData.val() != null"
              },
              "row_count": {
                ".validate": "newData.isNumber() && newData.val() < 1000 && (newData.parent().child(newData.parent().child('target_record_id').val()).val() == null ? 0 : 1) - (data.parent().child(newData.parent().child('target_record_id').val()).val() == null ? 0 : 1) == (newData.parent().child(newData.parent().child('target_record_id').val()).parent().child('row_count').val() == null ? 0 : newData.parent().child(newData.parent().child('target_record_id').val()).parent().child('row_count').val()) - (data.parent().child(newData.parent().child('target_record_id').val()).parent().child('row_count').val() == null ? 0 : data.parent().child(newData.parent().child('target_record_id').val()).parent().child('row_count').val())",
                ".write": "auth.uid != null && newData.val() != null"
              },
              "$record_id": {
                ".validate": "newData.isString()",
                ".write": "auth.uid != null && $record_id == newData.parent().child('target_record_id').val() && (newData.val() == null ? 0 : 1) - (data.val() == null ? 0 : 1) == (newData.parent().child('row_count').val() == null ? 0 : newData.parent().child('row_count').val()) - (data.parent().child('row_count').val() == null ? 0 : data.parent().child('row_count').val()) && (data.parent().parent().parent().child('limits').child(15 + '').child('used_ops').child(newData.parent().parent().parent().child('limits').child(15 + '').child('target_op_id').val() + '').val() == null && newData.parent().parent().parent().child('limits').child(15 + '').child('used_ops').child(newData.parent().parent().parent().child('limits').child(15 + '').child('target_op_id').val() + '').val() == true && (data.parent().parent().parent().child('limits').child(60 + '').child('used_ops').child(newData.parent().parent().parent().child('limits').child(60 + '').child('target_op_id').val() + '').val() == null && newData.parent().parent().parent().child('limits').child(60 + '').child('used_ops').child(newData.parent().parent().parent().child('limits').child(60 + '').child('target_op_id').val() + '').val() == true))"
              }
            }
          },
          "limits": {
            "15": {
              ".validate": "(newData.hasChildren() && newData.hasChildren(['counters']) || newData.val() == null) && (data.child('counters').child('last_reset_time').val() == null && newData.child('counters').child('last_reset_time').val() == now && newData.child('counters').child('last_op_count').val() == 1 && newData.child('used_ops').val() == null || newData.child('counters').child('last_reset_time').val() == data.child('counters').child('last_reset_time').val() && newData.child('target_op_id').val() == data.child('target_op_id').val() && (newData.child('used_ops').val() != null || data.child('used_ops').val() == null) && newData.child('counters').child('last_op_count').val() == data.child('counters').child('last_op_count').val() + 1 && newData.child('counters').child('last_op_count').val() <= 30 || newData.child('used_ops').val() == null && newData.child('counters').child('last_reset_time').val() == now && newData.child('counters').child('last_reset_time').val() > data.child('counters').child('last_reset_time').val() + 15000 && newData.child('counters').child('last_op_count').val() == 0 || newData.child('counters').child('last_op_count').val() == data.child('counters').child('last_op_count').val() && newData.child('counters').child('last_reset_time').val() == data.child('counters').child('last_reset_time').val() && (data.child('used_ops').child(newData.child('target_op_id').val() + '').val() == null && newData.child('used_ops').child(newData.child('target_op_id').val() + '').val() == true) && newData.child('target_op_id').val() <= newData.child('counters').child('last_op_count').val())",
              "counters": {
                ".validate": "newData.hasChildren() && newData.hasChildren(['last_reset_time', 'last_op_count'])",
                "last_reset_time": {
                  ".validate": "newData.isNumber()"
                },
                "last_op_count": {
                  ".validate": "newData.isNumber()"
                },
                "$other": {
                  ".validate": "false"
                }
              },
              "target_op_id": {
                ".validate": "newData.isNumber() || newData.val() == null"
              },
              "used_ops": {
                "$key1": {
                  ".validate": "newData.isBoolean()"
                }
              },
              "$other": {
                ".validate": "false"
              }
            },
            "60": {
              ".validate": "(newData.hasChildren() && newData.hasChildren(['counters']) || newData.val() == null) && (data.child('counters').child('last_reset_time').val() == null && newData.child('counters').child('last_reset_time').val() == now && newData.child('counters').child('last_op_count').val() == 1 && newData.child('used_ops').val() == null || newData.child('counters').child('last_reset_time').val() == data.child('counters').child('last_reset_time').val() && newData.child('target_op_id').val() == data.child('target_op_id').val() && (newData.child('used_ops').val() != null || data.child('used_ops').val() == null) && newData.child('counters').child('last_op_count').val() == data.child('counters').child('last_op_count').val() + 1 && newData.child('counters').child('last_op_count').val() <= 60 || newData.child('used_ops').val() == null && newData.child('counters').child('last_reset_time').val() == now && newData.child('counters').child('last_reset_time').val() > data.child('counters').child('last_reset_time').val() + 60000 && newData.child('counters').child('last_op_count').val() == 0 || newData.child('counters').child('last_op_count').val() == data.child('counters').child('last_op_count').val() && newData.child('counters').child('last_reset_time').val() == data.child('counters').child('last_reset_time').val() && (data.child('used_ops').child(newData.child('target_op_id').val() + '').val() == null && newData.child('used_ops').child(newData.child('target_op_id').val() + '').val() == true) && newData.child('target_op_id').val() <= newData.child('counters').child('last_op_count').val())",
              "counters": {
                ".validate": "newData.hasChildren() && newData.hasChildren(['last_reset_time', 'last_op_count'])",
                "last_reset_time": {
                  ".validate": "newData.isNumber()"
                },
                "last_op_count": {
                  ".validate": "newData.isNumber()"
                },
                "$other": {
                  ".validate": "false"
                }
              },
              "target_op_id": {
                ".validate": "newData.isNumber() || newData.val() == null"
              },
              "used_ops": {
                "$key1": {
                  ".validate": "newData.isBoolean()"
                }
              },
              "$other": {
                ".validate": "false"
              }
            },
            ".validate": "newData.hasChildren()",
            "$other": {
              ".validate": "false"
            },
            ".write": "auth.uid != null && newData.val() != null"
          }
        }
      }
    }
  }
}
